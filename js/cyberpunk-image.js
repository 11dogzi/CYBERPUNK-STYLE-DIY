import{app as e}from"../../scripts/app.js";class t extends LGraphNode{constructor(e){super(e),this.title=e,this.serialize_widgets=!0,this.isVirtualNode=!0,this.class_type=this.constructor.type,this.type=this.constructor.type,this.pos=[0,0]}static setUp(){this.registered||(LiteGraph.registerNodeType(this.type,this),this.registered=!0)}configure(e){e.properties&&Object.assign(this.properties,e.properties),e.pos&&(this.pos=e.pos),e.size&&(this.size=e.size),e.flags&&(this.flags=e.flags)}serialize(){const e=super.serialize();return!e.id&&this.id&&(e.id=this.id),e.order||void 0===this.order||(e.order=this.order),e.mode||void 0===this.mode||(e.mode=this.mode),e.properties={...this.properties},!e.pos&&this.pos&&(e.pos=[...this.pos]),!e.size&&this.size&&(e.size=[...this.size]),!e.flags&&this.flags&&(e.flags={...this.flags}),e}}class i extends t{constructor(t=i.title){super(t),this.flags=this.flags||{},this.flags.allow_interaction=!this.flags.pinned,this.properties={imageUrl:"",previewSize:256,fontSize:12,fontFamily:"Arial",fontColor:"#ffffff",backgroundColor:"#333333",backgroundAlpha:.8,borderRadius:8,padding:8,waitingText:"等待图像链接或Base64...",loadingText:"加载中..."},this.img=new Image,this.img.onload=()=>{!this.hasBeenResized&&256===this.size[0]&&this.size[1],e.graph.setDirtyCanvas(!0)},this.resizable=!0,this.size=[256,256],this.imageLoaded=!1,this.color="#fff0",this.bgcolor="#fff0",this.loadError=null,this.hasBeenResized=!1}onDrawBackground(e){if(!this.imageLoaded&&this.properties.imageUrl){const e=this.properties.imageUrl.trim();if(e.startsWith("http://")||e.startsWith("https://"))this.img.src=e;else try{let t=e;e.includes("base64,")?this.img.src=e:(t=t.replace(/[\n\r]/g,""),this.img.src="data:image/png;base64,"+t)}catch(e){console.error("Base64解码失败:",e),this.loadError="Base64解码失败"}this.imageLoaded=!0}const t=this.properties.borderRadius,i=(this.properties.padding,this.properties.backgroundColor),s=this.properties.backgroundAlpha;if(s>0){const r=e.fillStyle;e.fillStyle=this.hexToRGBA(i,s),t>0?(e.beginPath(),e.moveTo(t,0),e.lineTo(this.size[0]-t,0),e.quadraticCurveTo(this.size[0],0,this.size[0],t),e.lineTo(this.size[0],this.size[1]-t),e.quadraticCurveTo(this.size[0],this.size[1],this.size[0]-t,this.size[1]),e.lineTo(t,this.size[1]),e.quadraticCurveTo(0,this.size[1],0,this.size[1]-t),e.lineTo(0,t),e.quadraticCurveTo(0,0,t,0),e.closePath(),e.fill()):e.fillRect(0,0,this.size[0],this.size[1]),e.fillStyle=r}if(this.img.complete&&0!==this.img.naturalWidth){const t=e.globalAlpha,i=e.globalCompositeOperation,s=this.properties.previewSize,r=this.img.naturalWidth,o=this.img.naturalHeight;let a;a=r>=o?s/r:s/o;const l=r*a,n=o*a,p=(this.size[0]-l)/2,h=(this.size[1]-n)/2;try{l>0&&n>0?(e.globalAlpha=1,e.globalCompositeOperation="source-over",e.drawImage(this.img,p,h,l,n),e.globalAlpha=t,e.globalCompositeOperation=i):console.warn("图像绘制参数异常:",{x:p,y:h,drawWidth:l,drawHeight:n,nodeSize:this.size,scale:a,targetSize:s})}catch(s){console.error("图像绘制失败:",s),e.globalAlpha=t,e.globalCompositeOperation=i}}else{const t=e.fillStyle,i=e.font,s=e.textAlign;e.fillStyle=this.properties.fontColor,e.font=this.properties.fontSize+"px "+this.properties.fontFamily,e.textAlign="center",e.fillText(this.loadError||(this.properties.imageUrl?this.properties.loadingText:this.properties.waitingText),this.size[0]/2,this.size[1]/2),e.fillStyle=t,e.font=i,e.textAlign=s}}hexToRGBA(e,t){return"rgba("+parseInt(e.slice(1,3),16)+", "+parseInt(e.slice(3,5),16)+", "+parseInt(e.slice(5,7),16)+", "+t+")"}onPropertyChanged(t,i){"imageUrl"===t?(this.imageLoaded=!1,this.img.src="",this.loadError=null,e.graph.setDirtyCanvas(!0)):e.graph.setDirtyCanvas(!0)}onDblClick(e,t,i){LGraphCanvas.active_canvas.showShowNodePanel(this)}onResize(t){t&&Array.isArray(t)&&t.length>=2&&(this.size[0]=Math.max(t[0],50),this.size[1]=Math.max(t[1],50),this.hasBeenResized=!0,e.graph.setDirtyCanvas(!0))}getExtraMenuOptions(e,t){t.unshift({content:"设置预览大小",submenu:{options:[{content:"128x128",callback:()=>{this.properties.previewSize=128,this.onPropertyChanged("previewSize",128)}},{content:"256x256",callback:()=>{this.properties.previewSize=256,this.onPropertyChanged("previewSize",256)}},{content:"512x512",callback:()=>{this.properties.previewSize=512,this.onPropertyChanged("previewSize",512)}}]}}),t.push({content:"固定节点",callback:()=>{this.flags.pinned=!this.flags.pinned,this.flags.allow_interaction=!this.flags.pinned}})}onShowCustomPanelInfo(e){var t,i;null===(t=e.querySelector('div.property[data-property="Mode"]'))||void 0===t||t.remove(),null===(i=e.querySelector('div.property[data-property="Color"]'))||void 0===i||i.remove()}draw(e){this.flags=this.flags||{},this.flags.allow_interaction=!this.flags.pinned}}i.type="2🐕/CYBERPUNK",i.title="图像链接预览",i.title_mode=LiteGraph.NO_TITLE,i.collapsable=!1,i["@imageUrl"]={type:"string",title:"图像链接"},i["@previewSize"]={type:"number",title:"预览大小",default:256,min:64,max:1024,step:1},i["@fontSize"]={type:"number",title:"字体大小",default:12,min:8,max:32,step:1},i["@fontFamily"]={type:"string",title:"字体",default:"Arial"},i["@fontColor"]={type:"color",title:"字体颜色",default:"#ffffff"},i["@backgroundColor"]={type:"color",title:"背景颜色",default:"#333333"},i["@backgroundAlpha"]={type:"number",title:"背景透明度",default:0,min:0,max:1,step:.1},i["@borderRadius"]={type:"number",title:"圆角大小",default:8,min:0,max:50,step:1},i["@padding"]={type:"number",title:"内边距",default:8,min:0,max:50,step:1},i["@waitingText"]={type:"string",title:"等待提示文字",default:"等待图像链接或Base64..."},i["@loadingText"]={type:"string",title:"加载提示文字",default:"加载中..."};const s=LGraphCanvas.prototype.drawNode;LGraphCanvas.prototype.drawNode=function(e,t){if(e.constructor===i){e.bgcolor="transparent",e.color="#666666";const i=s.apply(this,arguments);return e.onDrawBackground(t),i}return s.apply(this,arguments)};const r={processingMouseDown:!1,lastMouseEvent:null,lastClickTime:0},o=LGraph.prototype.getNodeOnPos;LGraph.prototype.getNodeOnPos=function(e,t,s,a){if(s){const e=LiteGraph.getTime()-LGraphCanvas.active_canvas.last_mouseclick<300;r.processingMouseDown&&r.lastMouseEvent&&r.lastMouseEvent.type.includes("down")&&1===r.lastMouseEvent.which&&!e&&(s=[...s].filter((e=>!(e instanceof i&&e.flags.pinned))))}return o.apply(this,[e,t,s,a])},document.addEventListener("mousedown",(function(e){r.processingMouseDown=!0,r.lastMouseEvent=e}),!0),document.addEventListener("mouseup",(function(){r.processingMouseDown=!1}),!0),e.registerExtension({name:"2🐕.URLPreview",registerCustomNodes(){i.setUp()}});